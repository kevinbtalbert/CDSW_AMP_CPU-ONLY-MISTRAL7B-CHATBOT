name: CDF to CDSW Mistral 7B Chatbot
description: |
  Host internal open source Mistral 7B LLM in the form of UI and API endpoint with semantic search from custom knowledge base generated with CDF.

author: Cloudera Inc.
specification_version: 1.0
prototype_version: 1.0
date: "2023-11-07"

environment_variables:
  PYTHON_PATH:
    default: "/home/cdsw/.local/lib/python3.9/site-packages"
    description: "Leave this value as is. This is required by CDSW due to CDSW module overriding user installed modules."
    required: true

runtimes:
  - editor: Workbench
    kernel: Python 3.9
    edition: Standard

tasks:
  - type: run_session
    name: Install Dependencies
    script: 1_install_session_deps/download_requirements.py
    short_summary: Install Dependencies
    kernel: python3
    cpu: 4
    memory: 16

  - type: run_session
    name: Install Dependencies
    script: 1_install_session_deps/install_llama_deps.py
    short_summary: Install Llama Dependencies
    kernel: python3
    cpu: 2
    memory: 8
    
  - type: create_job
    name: Download Models
    entity_label: download_data_and_models
    script: 2_job-download-models/download_models.py
    arguments: None
    short_summary: Create job to download pre-trained models. 
    long_summary: Create job to download open source pre-trained models required by the application. All models are downloaded to a local directory. 
    cpu: 1
    memory: 4
    environment:
      TASK_TYPE: CREATE/RUN_JOB

  - type: run_job
    entity_label: download_data_and_models
    short_summary: Run job to download pre-trained models.

  - type: create_job
    name: Populate Vector DB with documents embeddings
    entity_label: vectordb_insert
    script: 3_job-populate-vectordb/vectordb_insert.py
    arguments: None
    short_summary: Create job to populate Vector Database with document embeddings. 
    long_summary: Create job to launch Milvus Vector Database locally and insert embeddings for documents. Embeddings are generated by the locally running embeddings model.
    cpu: 1
    memory: 4
    environment:
      TASK_TYPE: CREATE/RUN_JOB

  - type: run_job
    entity_label: vectordb_insert
    short_summary: Populate Vector DB with documents embeddings

  - type: start_application
    name: CDSW Mistral 7B Chatbot Interface
    subdomain: cdsw-mistral-ui
    script: 4_app/frontend_app.py
    short_summary: Create and start CDSW Mistral frontend application
    long_summary: Create and start CDSW Mistral 7B frontend application. Remember to enable unauthenticated app access for external access to the UI.
    cpu: 4
    memory: 16
    environment_variables:
      TASK_TYPE: START_APPLICATION
